-- -*- mode: lua; coding: windows-1251-dos -*-

function attach( sm )
  sm:subscribe({ signal = "on_key_down",       fun = this.on_key_down       })
  sm:subscribe({ signal = "on_mm_return_game", fun = this.on_mm_return_game })
  sm:subscribe({ signal = "on_spawn",          fun = this.on_spawn          })
end


function on_spawn()
  rebind_quick_save()
end


local dik_quick_save
function rebind_quick_save()
  dik_quick_save = {}
  local data   = dsh_cfg.get_data()
  local knames = parse_names( data.quick_save )
  for _, kn in ipairs( parse_names( data.quick_save ) ) do
    local dik = ogse_rebind_key.keyname_to_dik( kn )
    ASSERT( dik, "keyname to dik not found: %s", kn )
    dik_quick_save[ dik ] = true
  end
  cmd( "unbind quick_save" )
  cmd( "unbind_sec quick_save" )
end


function on_mm_return_game()
  rebind_quick_save()
end


function on_key_down( key, bind )
  if level.main_input_receiver() then return end
  if dik_quick_save[ key ] then
    if dsh.allowed_to_save() then
      dsh.make_quicksave()
    end
    return true
  end
end
