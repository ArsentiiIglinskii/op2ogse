-- -*- mode: lua; coding: windows-1251-dos -*-

function attach( sm )
  sm:subscribe({ signal = "on_before_first_update", fun = this.on_first_update })
end


local vname = "dsh_fixes.version"

function on_first_update()
  local fixes = {
    this.kill_journalist_npc,
    this.free_bar_visitors,
  }
  local version = ogse.load_var( vname, 0 )
  if version < table.getn( fixes ) then
    for i = 1, table.getn( fixes ) do
      fixes[ i ]()
    end
    ogse.save_var( vname, table.getn( fixes ), "u32" )
  end
end


-- —делать труп журналиста, который случайно заспаунилс€ живым
function kill_journalist_npc()
  local sobj = alife():story_object( story_ids.journalist_npc )
  if sobj then
    local obj = level.object_by_id( sobj.id )
    if obj then
      obj:kill( obj )
    else
      ogse.kill_offline_npc( sobj )
    end
  end
end

-- ”брать у сталкеров в Ѕаре жесткую прив€зку к этому смарту, что бы
-- они могли уходить.
function free_bar_visitors()
  local strn = smart_terrain.get_smart_terrain_by_name( "bar_visitors" )
  for id, v in pairs( strn.npc_info ) do
    local sobj = alife():object( id )
    local pk = xs_netpk.stalker( sobj )
    if pk:isOk() then
      local data = pk:get()
      local cd   = data.custom_data:getTable()
      cd.smart_terrains = nil
      data.custom_data:set( cd )
      pk:set( data )
    end
    sobj:clear_smart_terrain()
    strn:unregister_npc( sobj )
    sobj:brain():can_choose_alife_tasks( true )
    sobj:brain():update()
  end
end
