function attach( sm )
  sm:subscribe({ signal = "grenade_binder.net_destroy", fun = this.net_destroy })
  sm:subscribe({ signal = "grenade_binder.net_spawn", fun = this.net_spawn })
  sm:subscribe({ signal = "on_hit", fun = this.on_hit })
end

local last_actor_hit = nil
function on_hit( obj, amount, local_direction, who, bone_index )
  last_actor_hit = time_global()
end

function net_spawn( binder )
  binder.flash_spawn_time = time_global()
end

function net_destroy( binder )
  if binder.object:section() == "grenade_flash" then
    if is_hit_by_flash( binder ) then
      xr_sound.get_safe_sound_object( [[weapons\explo\grenade_flash]] ):play_no_feedback(db.actor, sound_object.s2d, 0, vector(), 1.0 )
      level.add_pp_effector( "teleport.ppe", 2000, false )
      dsh.timeout( 1500, flash_bum1 )
      return true
    end
  end
end

function is_hit_by_flash( binder )
    local cur_time = time_global()
    if db.actor and last_actor_hit
       and last_actor_hit > binder.flash_spawn_time
       and cur_time - binder.flash_spawn_time < 10000
       and db.actor:position():distance_to( binder.object:position() ) < 9
    then
      return true
    end
    return false
end

function flash_bum1()
  level.add_pp_effector( "snd_shock.ppe", 2994, true )
  dsh.timeout( 7000, flash_bum2 )
end

function flash_bum2()
  level.add_pp_effector( "total_recall.ppe", 2993, true )
  level.remove_pp_effector( 2994 )
  dsh.timeout( 2000, flash_bum3 )
end

function flash_bum3()
  level.remove_pp_effector(2993)
end
